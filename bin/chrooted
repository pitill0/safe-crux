#!/bin/bash

#
# chrooted: abstraction tool for chroot command
#

msgUsage() {
  echo "Usage: $0 path <command>"
  echo "Note that default command executed is /bin/sh"
  exit 0
}

msgError() {
  echo "Error, $@" 2>&1
  exit 1
}

main() {
  local FS
  # before ...
  for FS in dev proc sys tmp dev/pts; do
    if ! mount | grep $CHROOTFS/$FS >/dev/null 2>&1; then
      case $FS in
        dev|proc) mount --bind /$FS $CHROOTFS/$FS ;;
        sys|tmp) mount -t ${FS}fs ${FS}fs $CHROOTFS/$FS ;;
        dev/pts) mount -t devpts devpts $CHROOTFS/$FS ;;
      esac
    fi
  done
  # do chroot
  chroot $CHROOTFS $@
  # on exit ...
  for FS in dev/pts tmp sys proc dev; do
    if ! mount | grep $CHROOTFS/$FS >/dev/null 2>&1; then
      umount $CHROOTFS/$FS
    fi
  done
}

[ $# -lt 1 ] && msgUsage
[ ! -d $1 ] && msgError "directory '$1' not found"

CHROOTFS="$(cd $1; pwd)"

shift 1
main $@

# End of File
